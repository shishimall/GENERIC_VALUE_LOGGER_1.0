# generic_value_logger

import streamlit as st
import pandas as pd
import os
from datetime import datetime
from io import BytesIO
import gspread
from google.oauth2.service_account import Credentials

# ãƒ‡ãƒ¼ã‚¿ãƒ•ã‚¡ã‚¤ãƒ«å
FILENAME = "æ±ç”¨ã‚¹ã‚±ãƒ¼ãƒ«è¨˜éŒ².xlsx"

# Google Sheets èªè¨¼è¨­å®š
GSHEET_SCOPE = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
]

# ã“ã“ã«è¨¼æ˜æ›¸JSONã‚’ç½®ã
SERVICE_ACCOUNT_FILE = "gspread_service_account.json"
SPREADSHEET_ID = "ã“ã“ã«Googleã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆID"

# Google Sheets ãƒ­ãƒ¼ãƒ‰
@st.cache_resource
def load_gsheet():
    creds = Credentials.from_service_account_file(SERVICE_ACCOUNT_FILE, scopes=GSHEET_SCOPE)
    client = gspread.authorize(creds)
    return client.open_by_key(SPREADSHEET_ID).sheet1

sheet = None
try:
    sheet = load_gsheet()
except Exception as e:
    st.warning(f"Google Sheetsã®èª­ã¿è¾¼ã«å¤±æ•—ã—ã¾ã—ãŸ: {e}")

# ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿
if os.path.exists(FILENAME):
    df = pd.read_excel(FILENAME)
else:
    df = pd.DataFrame(columns=["æ—¥æ™‚", "ã‚«ãƒ†ã‚´ãƒª", "å€¤", "ãƒ¡ãƒ¢"])

# ã‚µã‚¤ãƒ‰ãƒãƒ¼
with st.sidebar:
    st.header(":pencil: æ–°è¦è¨˜éŒ²")
    category = st.text_input("ã‚«ãƒ†ã‚´ãƒª")
    value = st.text_input("å€¤")
    memo = st.text_area("ãƒ¡ãƒ¢", height=100)
    submit = st.button("è¨˜éŒ²")

    if submit and category and value:
        new_row = {
            "æ—¥æ™‚": datetime.now().strftime("%Y-%m-%d %H:%M"),
            "ã‚«ãƒ†ã‚´ãƒª": category,
            "å€¤": value,
            "ãƒ¡ãƒ¢": memo
        }
        df = pd.concat([pd.DataFrame([new_row]), df], ignore_index=True)
        df.to_excel(FILENAME, index=False)

        # Google Sheetsã¸è¿½åŠ 
        if sheet:
            try:
                sheet.insert_row([new_row[k] for k in df.columns], index=2)
            except Exception as e:
                st.warning(f"Google Sheetsã¸ã®è¿½åŠ ã«å¤±æ•—: {e}")

        st.success("è¨˜éŒ²ã—ã¾ã—ãŸï¼")
        st.rerun()

# ãƒ¡ã‚¤ãƒ³è¡¨ç¤º
st.title(":ledger: æ±ç”¨å€¤è¨˜éŒ²")
st.dataframe(df, use_container_width=True)

# ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒœã‚¿ãƒ³
output = BytesIO()
df.to_excel(output, index=False)
st.download_button(
    label="ğŸ“„ Excelãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰",
    data=output.getvalue(),
    file_name=FILENAME,
    mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
)
